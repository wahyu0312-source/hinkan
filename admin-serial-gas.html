<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Serial List</title>
<style>
  :root { --primary:#2563eb; --bg-body:#f8fafc; --surface:#ffffff; --border:#e2e8f0; }
  body { margin:0; font-family:sans-serif; background:var(--bg-body); padding-bottom:80px; }
  header { background:var(--surface); border-bottom:1px solid var(--border); padding:0 20px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:50; }
  .container { max-width:800px; margin:30px auto; padding:0 20px; }
  .item-card { background:var(--surface); border:1px solid var(--border); padding:20px; margin-bottom:15px; border-radius:12px; }
  input { padding:8px; border:1px solid #ccc; border-radius:4px; margin-right:5px; }
  button { padding:8px 12px; cursor:pointer; }
</style>
</head>
<body>
<header>
  <div style="font-weight:bold; color:var(--primary)">‚õΩ Serial List</div>
  <a href="./index.html" style="font-size:1.5rem; text-decoration:none">üè†</a>
</header>
<main class="container">
  <button onclick="addItem()" style="margin-bottom:20px;">+ Add Item</button>
  <div id="list"></div>
</main>
<script>
  // URL GAS ANDA
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxK8yMSd6nOJVGeKlcmCIGVgXIp5JIGmyvAsqBHo6lSCyZ1rgXMZImUYxxtksKC8wwF/exec';
  
  let list = JSON.parse(localStorage.getItem('kensa_serial_list')||'[]');

  function render(){
    const el = document.getElementById('list'); el.innerHTML = '';
    list.forEach((it, idx) => {
      const div = document.createElement('div'); div.className = 'item-card';
      div.innerHTML = `
        <input value="${it.prefix}" onchange="update(${idx}, 'prefix', this.value)" placeholder="KEY (NS::PFX)">
        <input value="${it.name}" onchange="update(${idx}, 'name', this.value)" placeholder="Name">
        <br><br>
        Digit: <input type="number" value="${it.digits||3}" style="width:50px" id="d-${idx}">
        Next: <input type="number" value="${it.next||1}" style="width:60px" id="n-${idx}">
        <br><br>
        <button onclick="syncInfo(${idx})">‚ÑπÔ∏è Sync Info</button>
        <button onclick="pushDigit(${idx})">Set Digit</button>
        <button onclick="pushNext(${idx})" style="color:red">Set Next</button>
        <button onclick="delItem(${idx})">üóë</button>
      `;
      el.appendChild(div);
    });
  }

  function update(idx, key, val){ list[idx][key] = val; localStorage.setItem('kensa_serial_list', JSON.stringify(list)); }
  function addItem(){ list.push({prefix:'', name:'', digits:3, next:1}); render(); }
  function delItem(idx){ if(confirm('Del?')){ list.splice(idx,1); localStorage.setItem('kensa_serial_list', JSON.stringify(list)); render(); } }

  async function api(body){ return fetch(GAS_URL, {method:'POST', body:JSON.stringify(body)}).then(r=>r.json()); }

  async function syncInfo(idx){
    try {
      const r = await api({action:'getInfo', prefix:list[idx].prefix});
      alert(`Server: D=${r.digits}, N=${r.next}`);
      if(r.digits) list[idx].digits = r.digits;
      if(r.next) list[idx].next = r.next;
      localStorage.setItem('kensa_serial_list', JSON.stringify(list)); render();
    } catch(e){ alert(e); }
  }

  async function pushNext(idx){
    const v = parseInt(document.getElementById('n-'+idx).value);
    if(confirm('Reset server counter?')) await api({action:'setNext', prefix:list[idx].prefix, next:v});
  }
  
  async function pushDigit(idx){
    const v = parseInt(document.getElementById('d-'+idx).value);
    await api({action:'setDigits', prefix:list[idx].prefix, digits:v});
  }

  render();
</script>
</body>
</html>
